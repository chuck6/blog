(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{1216:function(n,s,a){"use strict";a.r(s);var e=a(15),t=Object(e.a)({},(function(){var n=this,s=n.$createElement,a=n._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[a("h1",{attrs:{id:"alertmanager集成短信网关"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#alertmanager集成短信网关"}},[n._v("#")]),n._v(" Alertmanager集成短信网关")]),n._v(" "),a("p",[n._v("alertmanager集成告警邮件这块是有相应的相信的文档的，但是发现如果集成短信网关这块，相关文档不太多。alertmanager如果需要采用短信推送的话，大部分情况下，是要采用的是webhook的方式，短信网关服务还需要单独来购买，如果是集成企业中原有的短信告警的话，需要单独来开发接口来适配实现。")]),n._v(" "),a("p",[n._v("这里我采用的alertmanger中的webhook的功能把信息推送到python 写的接口API中，然后把接收到的数据进行清理筛选，然后以后的短信网关接口的方式，推送到短信网关。自己手写的python api相当于起到了协议转换、网关路由转发的作用，主要还是用于alertmanger 和既有的短信网关之间的协议适配的作用。")]),n._v(" "),a("p",[n._v("主要参考的文档的内容有如下："),a("a",{attrs:{href:"https://www.cnblogs.com/Pigs-Will-Fly/p/13361527.html",target:"_blank",rel:"noopener noreferrer"}},[n._v("Alertmanger集成webhook"),a("OutboundLink")],1)]),n._v(" "),a("h2",{attrs:{id:"alertmanager的配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#alertmanager的配置"}},[n._v("#")]),n._v(" Alertmanager的配置")]),n._v(" "),a("ol",[a("li",[a("p",[n._v("修改alertmanger.yml配置文件")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("global:\n  resolve_timeout: 5m\n \nroute:\n  group_by: [cluster, alertname]\n  group_wait: 10s\n  group_interval: 20s\n  repeat_interval: 20s\n  #repeat_interval: 1h\n  receiver: 'webhook'\nreceivers:\n- name: 'webhook'\n  webhook_configs:\n  - url: 'http://192.168.111.1:5000/send'\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br")])]),a("ul",[a("li",[a("p",[n._v("global是全局配置，全局配置中的配置的选项内容都是公共设置，可以作为其他配置项的默认值，也可以被其他配置项中的设置覆盖掉。")])]),n._v(" "),a("li",[a("p",[n._v("resolve_timeout 用于定义当alertmanager持续多长时间未接收到相同告警后，将该告警标记为告警专题为已解决的时间，默认是5分钟。")])]),n._v(" "),a("li",[a("p",[n._v("group_by 这个标签项是指点了要分组的标签，若一下子有很多告警内容，相同告警标签项的告警 会被合并为一个通知 发送给接收器，实现了告警的分组。通常，我们会定义为不同的alername或cluster")])]),n._v(" "),a("li",[a("p",[n._v("group_wait 设置从接收告警到发送的等待时间，若在等待时间内当前group 接收到了新的告警，这些告警会被合并成一个通知进行发送，默认设置为30s.")])]),n._v(" "),a("li",[a("p",[n._v("group_interval  设置相同group之间发送告警通知的时间间隔，默认设置为5分钟。")])]),n._v(" "),a("li",[a("p",[n._v("repeat_interval   设置告警成功发送后能够再次发送完全相同的告警的时间间隔，默认是4个小时。")])]),n._v(" "),a("li",[a("p",[n._v("注意: group_interval 和 repeat_interval 的区别")]),n._v(" "),a("p",[n._v("Alertmanager 在收到一条新的告警之后，会等待 group_wait 时间，对这条新的告警做一些分组、更新、静默的操作。当第一条告警经过 group_wait 时间之后，Alertmanager 会每隔 group_interval 时间检查一次这条告警，判断是否需要对这条告警进行一些操作，当 Alertmanager 经过 n 次 group_interval 的检查后，n * group_interval 恰好大于 repeat_interval 的时候，Alertmanager 才会将这条告警再次发送给对应的 receiver。")]),n._v(" "),a("p",[n._v("参考文档： "),a("a",{attrs:{href:"https://www.dianbanjiu.com/post/alertmanager-%E4%B8%AD%E4%B8%89%E4%B8%AA%E6%97%B6%E9%97%B4%E5%8F%82%E6%95%B0%E4%B8%8A%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91/",target:"_blank",rel:"noopener noreferrer"}},[n._v("group_interval 和 repeat_interval 的区别"),a("OutboundLink")],1)])]),n._v(" "),a("li",[a("p",[n._v("receiver 这个设置的是默认的 接收器")])]),n._v(" "),a("li",[a("p",[n._v("webhook_configs 调用API的URL 地址")])])])])]),n._v(" "),a("h2",{attrs:{id:"python接口配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#python接口配置"}},[n._v("#")]),n._v(" python接口配置")]),n._v(" "),a("p",[n._v("在192.168.1.100 上启动相应的配置接口。")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("# -*- coding:utf-8 -*-\nfrom flask import Flask, request\nimport requests\nimport json\nfrom time import time, sleep\nimport datetime\nimport yaml\napp1 = Flask(__name__)\n\n@app1.route('/send', methods=['POST'])\n\ndef send():\n    #转换从alertmanager获得的json数据为dict类型\n    print(type(request.data))\n    data = json.loads(request.data)   \n    alerts = data['alerts']  #获取key为alerts的数据赋值给变量alerts\n\n    f = open(\"sms_send.yaml\", 'r', encoding='utf-8')\n    cfg = f.read()\n    f.close()\n    cfg_data = yaml.load(cfg, Loader=yaml.FullLoader)\n\n    # print(type(alerts))\n    # print(alerts[0].get('labels').get('job'))\n    content_job = alerts[0].get('labels').get('job')\n\n    if content_job in (\"http_2xx\"):      \n      for j in cfg_data.get(\"yunwei\"):\n        for i in alerts:\n          info_labels = i.get('labels')     #i是一个dict类型数据，获取key为labels的数据\n          print(info_labels)\n          t1 =  datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n          info_annotations = i.get('annotations')\n          content = \"\"\"\n'告警名称': %s\n'告警时间': %s\n      \"\"\" % (info_labels.get('alertname'),t1)         \n\n          by = bytes(content, 'gbk')   # string转换为16进制\n          hexstring = by.hex()\n\n          phone_number = j\n\n          xml_body = \"\"\"\n<ContractRoot>\n...........\n</ContractRoot>\n    \"\"\" %(phone_number,hexstring)\n    # print(type(xml_body))\n    # print(xml_body)\n        # url 是相应的短信网关\n        url = \"http://xxxxxxx\"\n        response = requests.post(url, data=xml_body.encode(\"utf-8\"))\n        with open(\"yichang.txt\",\"a\",encoding='utf-8') as f:\n          f.write(\"%s 调用%d 1次\\n\" %(t1,j))\n        # print(response.text)\n\n    return '调用成功'        \n\n\nif __name__ == '__main__':\n    app1.run(debug=True,host='0.0.0.0',port=5000)\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br"),a("span",{staticClass:"line-number"},[n._v("55")]),a("br"),a("span",{staticClass:"line-number"},[n._v("56")]),a("br"),a("span",{staticClass:"line-number"},[n._v("57")]),a("br"),a("span",{staticClass:"line-number"},[n._v("58")]),a("br"),a("span",{staticClass:"line-number"},[n._v("59")]),a("br"),a("span",{staticClass:"line-number"},[n._v("60")]),a("br"),a("span",{staticClass:"line-number"},[n._v("61")]),a("br"),a("span",{staticClass:"line-number"},[n._v("62")]),a("br")])]),a("p",[n._v("其中sms_send.yaml 是定义的发送的 短信分组号码")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("db_group:\n  - 1234567890\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br")])])])}),[],!1,null,null,null);s.default=t.exports}}]);